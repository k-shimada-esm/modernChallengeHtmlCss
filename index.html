<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <?!= HtmlService.createHtmlOutputFromFile('style').getContent(); ?>
    <title>bookApp</title>
</head>

<body onLoad='created()'>
  <header>
    <h1>
        書籍管理
    </h1>
  </header>
  <div>
    <input class='registration-button' type='button' value='新規登録'>
  </div>
  <table>
    <thead>
      <th>書籍番号</th>
      <th>タイトル</th>
      <th>ジャンル</th>
      <th>購入日</th>
      <th>購入者</th>
    </thead>
    <tbody id='bookDataList'></tbody>
  </table>

  <script type='text/javascript'>
    async function created() {
      const books = []; // 一覧データ

      // 一覧データの取得
      try {
        await this.loadData();
      } catch (error) {
        console.log('loadData ERROR');
        alert(`情報を取得できませんでした。[${error}]`)
      }

      // テーブルにデータを登録する
      const bookListElement = document.getElementById('bookDataList');
      this.books.forEach(bookInfo => {
        const tr = document.createElement('tr');
        this.generateTd(tr, 'book-no', bookInfo.bookNo);
        this.generateTd(tr, 'title', bookInfo.title);
        this.generateTd(tr, 'genre', bookInfo.genre);
        this.generateTd(tr, 'purchase-date', bookInfo.purchaseDate);
        this.generateTd(tr, 'purchase-person', bookInfo.purchasePerson);
        bookListElement.appendChild(tr);
      })
    };
    /**
     * テーブルエレメントにデータエレメントをセットする
     * @param {tr} TR エレメント
     * @param {className} セルのスタイル名
     * @param {tdValue} TD 値
     * @return {tr} TR エレメント
     */
    function generateTd(tr, className, tdValue) {
      const td = document.createElement('td');
      td.textContent = tdValue;
      if (className) {
        td.className = className;
      }
      tr.appendChild(td);
    };

    /**
     * 親画面から受け取った検索フィルタデータの条件にヒットした書籍データを取得する
     *   ※検索フィルタデータが初期値の場合は全件検索される
     * @return {配列} 書籍データ
     */
    async function loadData () {
      // 書籍テーブルから書籍データを取得する
      const bookData = await new Promise((resolve, reject) => {
        window.google.script.run
          .withSuccessHandler(pData => resolve(pData))
          .withFailureHandler(Error => reject(Error))
          .readFromBookTableByFilter('', '')
      });
      this.books = bookData.books;
    }
  </script>
</body>
</html>
